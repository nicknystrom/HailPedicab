// Generated by CoffeeScript 1.6.3
jQuery(function($) {
  var REFRESH_INTERVAL, fare, map, marker, navigate, process, refresh;
  navigate = function(target, data) {
    $('section:visible').hide();
    return $(target).show().trigger('navigate', data);
  };
  $('[data-navigate]').click(function() {
    return navigate($(this).data('navigate'));
  });
  process = function(data, next) {
    var f, _i, _len, _ref;
    if (!data) {
      return next('no-data');
    }
    $('#drivers > header > h1').text(data.driver.name);
    $('#drivers > header > h2').text(data.driver.email);
    $('#signout').toggle(true);
    $('#available > ul').empty();
    _ref = data.fares;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      f = _ref[_i];
      $('#available > ul').append($("<li data-id=\"" + f.id + "\">                    <span class=\"name\"><span class=\"value\">" + f.name + "</span></span>                    <span class=\"distance\"><span class=\"value\">" + 3 + " miles</span></span>                    <span class=\"since\"><span class=\"value\">" + (moment(f.created).fromNow()) + "</span></span>                </li>").data('fare', f));
    }
    next();
    if (data.fare) {
      if (data.fare.state === 'canceled') {
        return navigate('#canceled');
      }
      $('#fare').toggleClass('dispatched', true);
      return navigate('#fare', data.fare);
    }
  };
  REFRESH_INTERVAL = 20 * 1000;
  refresh = function(next) {
    var req;
    req = $.ajax({
      type: 'get',
      url: '/api/driver'
    });
    req.done(function(data) {
      return process(data, function() {
        if (next) {
          next();
        }
        return setTimeout(refresh, REFRESH_INTERVAL);
      });
    });
    return req.fail(function(err) {
      if (err.status === 401) {
        return navigate('#start');
      }
    });
  };
  refresh(function() {
    return navigate('#available');
  });
  $('#start').on('navigate', function() {});
  $('#signout').click(function() {
    var req;
    req = $.ajax({
      type: 'delete',
      url: '/api/session'
    });
    req.done(function(data) {
      alert('Thanks for driving!');
      return window.location.reload();
    });
    req.fail(function(err) {
      return alert('Whoops, failed to signout.');
    });
    return false;
  });
  $('#login').on('submit', function() {
    return false;
  }).h5Validate().on('formValidated', function(e, data) {
    var req;
    if (!data.valid) {
      return;
    }
    req = $.ajax({
      type: 'post',
      url: '/api/session',
      data: {
        name: $('#login-name').val(),
        email: $('#login-email').val()
      }
    });
    req.done(function(data) {
      return process(data, function() {
        navigate('#available');
        return setTimeout(refresh, REFRESH_INTERVAL);
      });
    });
    req.fail(function(err) {
      return alert('Email or pin is incorrect.');
    });
    return false;
  });
  $('#register').on('submit', function() {
    return false;
  }).h5Validate().on('formValidated', function(e, data) {
    var req;
    if (!data.valid) {
      return;
    }
    req = $.ajax({
      type: 'post',
      url: '/api/driver',
      data: {
        name: $('#register-name').val(),
        email: $('#register-email').val(),
        pin: $('#register-pin').val()
      }
    });
    req.done(function(data) {
      return process(data, function() {
        navigate('#available');
        return setTimeout(refresh, REFRESH_INTERVAL);
      });
    });
    req.fail(function(err) {
      return alert("Error creating your account:\n" + err.responseText);
    });
    return false;
  });
  $('#available').on('click', 'li', function(e) {
    $('#fare').toggleClass('dispatched', false);
    return navigate('#fare', $(e.currentTarget).data('fare'));
  });
  fare = null;
  map = null;
  marker = null;
  $('#fare').on('navigate', function(e, f) {
    if (fare === f) {
      return;
    }
    fare = f;
    $('#fare .name').text(f.name);
    if (!map) {
      map = new google.maps.Map($('#fare .map')[0], {
        center: new google.maps.LatLng(f.lat, f.long),
        zoom: 14,
        zoomControl: false,
        streetViewControl: false,
        mapTypeControl: false,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      });
      return marker = new google.maps.Marker({
        map: map,
        position: new google.maps.LatLng(f.lat, f.long),
        title: f.name
      });
    } else {
      marker.setPosition(new google.maps.LatLng(f.lat, f.long));
      marker.setTitle(f.name);
      map.setCenter(new google.maps.LatLng(f.lat, f.long));
      return map.setZoom(14);
    }
  });
  $('#fare button.dispatch').on('click', function() {
    var req;
    req = $.ajax({
      type: 'post',
      url: '/api/dispatch/' + fare.id,
      data: {
        estimate: moment().add(Number($(this).data('estimate')), 'm').toDate()
      }
    });
    req.done(function(data) {
      return process(data, function(err) {});
    });
    return req.fail(function(err) {
      return alert(err.responseText);
    });
  });
  $('#fare button.pickup').on('click', function() {
    var req;
    req = $.ajax({
      type: 'put',
      url: '/api/dispatch/' + fare.id
    });
    req.done(function(data) {
      return process(data, function(err) {
        return navigate('#available');
      });
    });
    return req.fail(function(err) {
      return alert(err.responseText);
    });
  });
  $('#fare button.cancel').on('click', function() {
    var req;
    if (confirm('Are you sure you can\'t or won\'t find this fare?')) {
      req = $.ajax({
        type: 'delete',
        url: '/api/dispatch/' + fare.id
      });
      req.done(function(data) {
        return process(data, function(err) {
          return navigate('#available');
        });
      });
      return req.fail(function(err) {
        return alert(err.responseText);
      });
    }
  });
  return $('#canceled button.done').on('click', function() {
    var req;
    req = $.ajax({
      type: 'delete',
      url: '/api/dispatch'
    });
    req.done(function(data) {
      return process(data, function(err) {
        return navigate('#available');
      });
    });
    return req.fail(function(err) {
      return alert(err.responseText);
    });
  });
});
