// Generated by CoffeeScript 1.6.3
jQuery(function($) {
  var navigate, process, req;
  navigate = function(target) {
    $('section:visible').hide();
    return $(target).show().trigger('navigate');
  };
  $('[data-navigate]').click(function() {
    return navigate($(this).data('navigate'));
  });
  process = function(data, next) {
    if (!data) {
      next();
    }
    $('#drivers > header > h1').text(data.driver.name);
    $('#drivers > header > h2').text(data.driver.email);
    return $('#signout').toggle(true);
  };
  req = $.ajax({
    type: 'get',
    url: '/api/driver'
  });
  req.done(function(data) {
    return process(data, function(err) {});
  });
  req.fail(function(err) {
    if (err.status === 401) {
      return navigate('#start');
    }
  });
  $('#start').on('navigate', function() {});
  $('#signout').click(function() {
    req = $.ajax({
      type: 'delete',
      url: '/api/session'
    });
    req.done(function(data) {
      alert('Thanks for driving!');
      return window.location.reload();
    });
    req.fail(function(err) {
      return alert('Whoops, failed to signout.');
    });
    return false;
  });
  $('#login').on('submit', function() {
    return false;
  }).h5Validate().on('formValidated', function(e, data) {
    if (!data.valid) {
      return;
    }
    req = $.ajax({
      type: 'post',
      url: '/api/session',
      data: {
        name: $('#login-name').val(),
        email: $('#login-email').val()
      }
    });
    req.done(function(data) {
      return process(data, function(err, data) {
        return navigate('#fares');
      });
    });
    req.fail(function(err) {
      return alert('Email or pin is incorrect.');
    });
    return false;
  });
  return $('#register').on('submit', function() {
    return false;
  }).h5Validate().on('formValidated', function(e, data) {
    if (!data.valid) {
      return;
    }
    req = $.ajax({
      type: 'post',
      url: '/api/driver',
      data: {
        name: $('#register-name').val(),
        email: $('#register-email').val(),
        pin: $('#register-pin').val()
      }
    });
    req.done(function(data) {
      return process(data, function(err, data) {
        return navigate('#fares');
      });
    });
    req.fail(function(err) {
      return alert("Error creating your account:\n" + err.responseText);
    });
    return false;
  });
});
